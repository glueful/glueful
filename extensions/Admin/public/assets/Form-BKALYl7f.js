var $=Object.defineProperty;var L=(a,n,s)=>n in a?$(a,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[n]=s;var O=(a,n,s)=>L(a,typeof n!="symbol"?n+"":n,s);import{f as B,a6 as z,a7 as Q,aa as R,aR as G,aS as T,r as j,A as V,aT as H,ay as K,a1 as W,a2 as Z,aN as q,aU as x,aV as ee,aW as ae,i as te,o as re,j as ne,m as se,X as ie,Q as le,l as X,S as oe,aX as ue}from"./index-CvplhhIg.js";function ce(a){return a.validate&&a.__isYupSchema__}function de(a){return a.inner!==void 0}function fe(a){return"schema"in a&&typeof a.coercer=="function"&&typeof a.validator=="function"&&typeof a.refiner=="function"}function me(a){return a.validateAsync!==void 0&&a.id!==void 0}function pe(a){return a.isJoi===!0}function ye(a){return"~standard"in a}async function ve(a,n){var t;const s=await n["~standard"].validate(a);return s.issues?{errors:((t=s.issues)==null?void 0:t.map(l=>{var u;return{name:((u=l.path)==null?void 0:u.map(m=>typeof m=="object"?m.key:m).join("."))||"",message:l.message}}))||[],result:null}:{errors:null,result:s.value}}async function he(a,n){try{return{errors:null,result:await n.validate(a,{abortEarly:!1})}}catch(s){if(de(s))return{errors:s.inner.map(l=>({name:l.path??"",message:l.message})),result:null};throw s}}async function we(a,n){const[s,t]=n.validate(a);return s?{errors:s.failures().map(u=>({message:u.message,name:u.path.join(".")})),result:null}:{errors:null,result:t}}async function Se(a,n){try{return{errors:null,result:await n.validateAsync(a,{abortEarly:!1})}}catch(s){if(pe(s))return{errors:s.details.map(l=>({name:l.path.join("."),message:l.message})),result:null};throw s}}function be(a,n){if(ye(n))return ve(a,n);if(me(n))return Se(a,n);if(ce(n))return he(a,n);if(fe(n))return we(a,n);throw new Error("Form validation failed: Unsupported form schema")}class F extends Error{constructor(s,t,l){super("Form validation exception");O(this,"formId");O(this,"errors");O(this,"children");this.formId=s,this.errors=t,this.children=l,Object.setPrototypeOf(this,F.prototype)}}const ge={base:""},je={__name:"Form",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:null,required:!1,default:()=>!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(a,{expose:n,emit:s}){const t=a,l=s,u=Q(),m=B(()=>{var e;return z({extend:z(ge),...((e=u.ui)==null?void 0:e.form)||{}})}),p=t.id??R(),C=H(`form-${p}`),y=t.attach&&G(T,void 0);q(T,C);const k=j(new Map);V(async()=>{C.on(async e=>{var r;e.type==="attach"?k.value.set(e.formId,{validate:e.validate}):e.type==="detach"?k.value.delete(e.formId):(r=t.validateOn)!=null&&r.includes(e.type)&&!c.value&&(e.type!=="input"?await v({name:e.name,silent:!0,nested:!1}):(e.eager||D.has(e.name))&&await v({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&D.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&Y.add(e.name),(e.type==="change"||e.type==="input")&&A.add(e.name)})}),W(()=>{C.reset()}),V(async()=>{y&&(await Z(),y.emit({type:"attach",validate:v,formId:p}))}),W(()=>{y&&y.emit({type:"detach",formId:p})});const i=j([]);q("form-errors",i);const _=j({});q(ue,_);const A=K(new Set),Y=K(new Set),D=K(new Set);function J(e){return e.map(r=>{var o;return{...r,id:r!=null&&r.name?(o=_.value[r.name])==null?void 0:o.id:void 0}})}const M=j(null);async function N(){let e=t.validate?await t.validate(t.state)??[]:[];if(t.schema){const{errors:r,result:o}=await be(t.state,t.schema);r?e=e.concat(r):M.value=o}return J(e)}async function v(e={silent:!1,nested:!0,transform:!1}){const r=e.name&&!Array.isArray(e.name)?[e.name]:e.name,o=!r&&e.nested?Array.from(k.value.values()).map(({validate:f})=>f(e).then(()=>{}).catch(h=>{if(!(h instanceof F))throw h;return h})):[];if(r){const f=i.value.filter(w=>!r.some(S=>{var g,E,I;const b=(E=(g=_.value)==null?void 0:g[S])==null?void 0:E.pattern;return S===w.name||b&&((I=w.name)==null?void 0:I.match(b))})),h=(await N()).filter(w=>r.some(S=>{var g,E,I;const b=(E=(g=_.value)==null?void 0:g[S])==null?void 0:E.pattern;return S===w.name||b&&((I=w.name)==null?void 0:I.match(b))}));i.value=f.concat(h)}else i.value=await N();const d=(await Promise.all(o)).filter(f=>f!==void 0);if(i.value.length+d.length>0){if(e.silent)return!1;throw new F(p,i.value,d)}return e.transform&&Object.assign(t.state,M.value),t.state}const c=j(!1);q(ee,x(c));async function P(e){var o;c.value=t.loadingAuto&&!0;const r=e;try{r.data=await v({nested:!0,transform:t.transform}),await((o=t.onSubmit)==null?void 0:o.call(t,r)),A.clear()}catch(d){if(!(d instanceof F))throw d;const f={...r,errors:d.errors,children:d.children};l("error",f)}finally{c.value=!1}}const U=B(()=>t.disabled||c.value);return q(ae,B(()=>({disabled:U.value,validateOnInputDelay:t.validateOnInputDelay}))),n({validate:v,errors:i,setErrors(e,r){r?i.value=i.value.filter(o=>o.name!==r).concat(J(e)):i.value=J(e)},async submit(){await P(new Event("submit"))},getErrors(e){return e?i.value.filter(r=>r.name===e):i.value},clear(e){e?i.value=i.value.filter(r=>r.name!==e):i.value=[]},disabled:U,loading:c,dirty:B(()=>!!A.size),dirtyFields:x(A),blurredFields:x(D),touchedFields:x(Y)}),(e,r)=>(re(),te(oe(X(y)?"div":"form"),{id:X(p),class:ie(m.value({class:t.class})),onSubmit:le(P,["prevent"])},{default:ne(()=>[se(e.$slots,"default",{errors:i.value,loading:c.value})]),_:3},40,["id","class"]))}};export{je as _};
