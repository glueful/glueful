var L=Object.defineProperty;var R=(a,n,s)=>n in a?L(a,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[n]=s;var O=(a,n,s)=>R(a,typeof n!="symbol"?n+"":n,s);import{f as x,a6 as N,a7 as W,aa as X,aQ as G,aR as Q,r as j,A as T,ax as K,a1 as V,a2 as H,aM as q,aS as B,aT as Z,aU as ee,i as ae,o as te,j as re,m as ne,X as se,Q as ie,l as $,S as le,aV as oe}from"./index-CRsdYi2H.js";import{u as ue}from"./index-DB23InID.js";function ce(a){return a.validate&&a.__isYupSchema__}function de(a){return a.inner!==void 0}function fe(a){return"schema"in a&&typeof a.coercer=="function"&&typeof a.validator=="function"&&typeof a.refiner=="function"}function me(a){return a.validateAsync!==void 0&&a.id!==void 0}function pe(a){return a.isJoi===!0}function ye(a){return"~standard"in a}async function ve(a,n){var t;const s=await n["~standard"].validate(a);return s.issues?{errors:((t=s.issues)==null?void 0:t.map(l=>{var u;return{name:((u=l.path)==null?void 0:u.map(m=>typeof m=="object"?m.key:m).join("."))||"",message:l.message}}))||[],result:null}:{errors:null,result:s.value}}async function he(a,n){try{return{errors:null,result:await n.validate(a,{abortEarly:!1})}}catch(s){if(de(s))return{errors:s.inner.map(l=>({name:l.path??"",message:l.message})),result:null};throw s}}async function we(a,n){const[s,t]=n.validate(a);return s?{errors:s.failures().map(u=>({message:u.message,name:u.path.join(".")})),result:null}:{errors:null,result:t}}async function Se(a,n){try{return{errors:null,result:await n.validateAsync(a,{abortEarly:!1})}}catch(s){if(pe(s))return{errors:s.details.map(l=>({name:l.path.join("."),message:l.message})),result:null};throw s}}function be(a,n){if(ye(n))return ve(a,n);if(me(n))return Se(a,n);if(ce(n))return he(a,n);if(fe(n))return we(a,n);throw new Error("Form validation failed: Unsupported form schema")}class F extends Error{constructor(s,t,l){super("Form validation exception");O(this,"formId");O(this,"errors");O(this,"children");this.formId=s,this.errors=t,this.children=l,Object.setPrototypeOf(this,F.prototype)}}const ge={base:""},qe={__name:"Form",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:null,required:!1,default:()=>!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(a,{expose:n,emit:s}){const t=a,l=s,u=W(),m=x(()=>{var e;return N({extend:N(ge),...((e=u.ui)==null?void 0:e.form)||{}})}),p=t.id??X(),C=ue(`form-${p}`),y=t.attach&&G(Q,void 0);q(Q,C);const k=j(new Map);T(async()=>{C.on(async e=>{var r;e.type==="attach"?k.value.set(e.formId,{validate:e.validate}):e.type==="detach"?k.value.delete(e.formId):(r=t.validateOn)!=null&&r.includes(e.type)&&!c.value&&(e.type!=="input"?await v({name:e.name,silent:!0,nested:!1}):(e.eager||D.has(e.name))&&await v({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&D.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&M.add(e.name),(e.type==="change"||e.type==="input")&&A.add(e.name)})}),V(()=>{C.reset()}),T(async()=>{y&&(await H(),y.emit({type:"attach",validate:v,formId:p}))}),V(()=>{y&&y.emit({type:"detach",formId:p})});const i=j([]);q("form-errors",i);const _=j({});q(oe,_);const A=K(new Set),M=K(new Set),D=K(new Set);function J(e){return e.map(r=>{var o;return{...r,id:r!=null&&r.name?(o=_.value[r.name])==null?void 0:o.id:void 0}})}const Y=j(null);async function P(){let e=t.validate?await t.validate(t.state)??[]:[];if(t.schema){const{errors:r,result:o}=await be(t.state,t.schema);r?e=e.concat(r):Y.value=o}return J(e)}async function v(e={silent:!1,nested:!0,transform:!1}){const r=e.name&&!Array.isArray(e.name)?[e.name]:e.name,o=!r&&e.nested?Array.from(k.value.values()).map(({validate:f})=>f(e).then(()=>{}).catch(h=>{if(!(h instanceof F))throw h;return h})):[];if(r){const f=i.value.filter(w=>!r.some(S=>{var g,E,I;const b=(E=(g=_.value)==null?void 0:g[S])==null?void 0:E.pattern;return S===w.name||b&&((I=w.name)==null?void 0:I.match(b))})),h=(await P()).filter(w=>r.some(S=>{var g,E,I;const b=(E=(g=_.value)==null?void 0:g[S])==null?void 0:E.pattern;return S===w.name||b&&((I=w.name)==null?void 0:I.match(b))}));i.value=f.concat(h)}else i.value=await P();const d=(await Promise.all(o)).filter(f=>f!==void 0);if(i.value.length+d.length>0){if(e.silent)return!1;throw new F(p,i.value,d)}return e.transform&&Object.assign(t.state,Y.value),t.state}const c=j(!1);q(Z,B(c));async function U(e){var o;c.value=t.loadingAuto&&!0;const r=e;try{r.data=await v({nested:!0,transform:t.transform}),await((o=t.onSubmit)==null?void 0:o.call(t,r)),A.clear()}catch(d){if(!(d instanceof F))throw d;const f={...r,errors:d.errors,children:d.children};l("error",f)}finally{c.value=!1}}const z=x(()=>t.disabled||c.value);return q(ee,x(()=>({disabled:z.value,validateOnInputDelay:t.validateOnInputDelay}))),n({validate:v,errors:i,setErrors(e,r){r?i.value=i.value.filter(o=>o.name!==r).concat(J(e)):i.value=J(e)},async submit(){await U(new Event("submit"))},getErrors(e){return e?i.value.filter(r=>r.name===e):i.value},clear(e){e?i.value=i.value.filter(r=>r.name!==e):i.value=[]},disabled:z,loading:c,dirty:x(()=>!!A.size),dirtyFields:B(A),blurredFields:B(D),touchedFields:B(M)}),(e,r)=>(te(),ae(le($(y)?"div":"form"),{id:$(p),class:se(m.value({class:t.class})),onSubmit:ie(U,["prevent"])},{default:re(()=>[ne(e.$slots,"default",{errors:i.value,loading:c.value})]),_:3},40,["id","class"]))}};export{qe as _};
